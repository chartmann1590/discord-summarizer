{% extends "base.html" %}

{% block title %}Dashboard - Discord Summarizer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Channel Summaries Dashboard</h1>
        <p class="text-muted">View the latest summaries for your monitored Discord channels</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" id="runNowBtn" onclick="runNow()">
            <i class="bi bi-play-circle"></i> Run Now
            <span class="spinner-border spinner-border-sm loading" role="status"></span>
        </button>
    </div>
</div>

{% for server_name, channels in servers %}
<div class="mb-4">
    <h3 class="text-primary">
        <i class="bi bi-server"></i> {{ server_name }}
    </h3>
    <div class="row">
        {% for channel in channels %}
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-hash"></i> {{ channel.name }}
                        <small class="float-end opacity-75">{{ channel.id }}</small>
                    </h5>
                </div>
                <div class="card-body">
                    {% if channel.latest_summary %}
                        <h6 class="card-subtitle mb-2 text-muted">
                            Latest Summary - {{ channel.latest_summary.formatted_timestamp(config) }}
                        </h6>
                        <p class="card-text summary-text">{{ channel.latest_summary.summary_text[:300] }}{% if channel.latest_summary.summary_text|length > 300 %}...{% endif %}</p>
                        <p class="text-muted">
                            <small>
                                <i class="bi bi-chat-dots"></i> {{ channel.latest_summary.message_count }} messages summarized
                            </small>
                        </p>
                    {% else %}
                        <p class="text-muted">No summaries yet</p>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('main.channel_summaries', channel_id=channel.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-list"></i> View All Summaries
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}

{% if not servers %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No channels configured. Please go to the configuration page to add channels.
</div>
{% endif %}

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Summary Generation Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultsBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function runNow() {
    const btn = document.getElementById('runNowBtn');
    const spinner = btn.querySelector('.loading');
    
    btn.disabled = true;
    spinner.classList.add('show');
    
    try {
        const response = await fetch('/run-now', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showResults(data.results);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        spinner.classList.remove('show');
    }
}

function showResults(results) {
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const body = document.getElementById('resultsBody');
    
    let html = '<ul class="list-group">';
    for (const result of results) {
        const statusClass = result.status === 'success' ? 'success' : 'danger';
        const icon = result.status === 'success' ? 'check-circle' : 'x-circle';
        html += `
            <li class="list-group-item">
                <i class="bi bi-${icon} text-${statusClass}"></i>
                Channel ${result.channel_id}: ${result.status}
                ${result.error ? `<br><small class="text-danger">${result.error}</small>` : ''}
            </li>
        `;
    }
    html += '</ul>';
    
    body.innerHTML = html;
    modal.show();
}
</script>
{% endblock %}